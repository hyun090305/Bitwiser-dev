<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OAuth Callback</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f7f7f7;
      color: #222;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <p>Authorization completed. You may close this window.</p>
  <script>
    (function () {
      function parseParams() {
        const query = window.location.search ? window.location.search.substring(1) : '';
        const params = new URLSearchParams(query);
        return {
          code: params.get('code'),
          state: params.get('state'),
          error: params.get('error'),
          error_description: params.get('error_description')
        };
      }

      function notifyParent() {
        const data = parseParams();
        const message = {
          type: 'drive_oauth_callback',
          state: data.state || null
        };
        if (data.error) {
          message.error = data.error;
          if (data.error_description) {
            message.error_description = data.error_description;
          }
        } else if (data.code) {
          message.code = data.code;
        }
        const targetOrigin = window.location.origin;
        if (window.opener && typeof window.opener.postMessage === 'function') {
          window.opener.postMessage(message, targetOrigin);
        } else if (window.parent && window.parent !== window && typeof window.parent.postMessage === 'function') {
          window.parent.postMessage(message, targetOrigin);
        }
        setTimeout(() => window.close(), 150);
      }

      window.addEventListener('load', notifyParent);
    })();
  </script>
</body>
</html>
